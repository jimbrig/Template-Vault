var O=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var tt=(s,r)=>{for(var t in r)O(s,t,{get:r[t],enumerable:!0})},et=(s,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Y(r))!Z.call(s,n)&&n!==t&&O(s,n,{get:()=>r[n],enumerable:!(e=X(r,n))||e.enumerable});return s};var nt=s=>et(O({},"__esModule",{value:!0}),s);var ut={};tt(ut,{default:()=>W});module.exports=nt(ut);var y=require("obsidian");function m(s,r){let t=Object.keys(r).map(e=>ot(s,e,r[e]));return t.length===1?t[0]:function(){t.forEach(e=>e())}}function ot(s,r,t){let e=s[r],n=s.hasOwnProperty(r),o=t(e);return e&&Object.setPrototypeOf(o,e),Object.setPrototypeOf(a,o),s[r]=a,d;function a(...l){return o===e&&s[r]===a&&d(),o.apply(this,l)}function d(){s[r]===a&&(n?s[r]=e:delete s[r]),o!==e&&(o=e,Object.setPrototypeOf(a,e||Function))}}function H(s,r){return s.then(r,r)}function j(s){let r=Promise.resolve();function t(...e){return r=new Promise((n,o)=>{H(r,()=>{s.apply(this,e).then(n,o)})})}return t.after=function(){return r=new Promise((e,n)=>{H(r,e)})},t}var b=require("obsidian");var R=Symbol.for("v1.to-use.peak-dev.org"),I=Symbol.for("v1.factory.to-use.peak-dev.org"),x,T,E=function(){return Object.defineProperties(s(),{this:{get(){if(x)return x;throw new TypeError("No current context")}},me:{value:R},factory:{value:I}});function s(n){let o=new Map;o.prev=n;let a=Object.assign(n?l=>{let i=o.get(l);if(!i){for(let u=o.prev;u;u=u.prev)if(i=u.get(l)){i=Object.assign(Object.assign({},i),{s:i.s||1});break}i=i||{s:2,v:t},o.set(l,i)}let f,h,p;for(;;)switch(i.s){case 0:return x===a&&T&&T.push(l),i.v;case 1:if(f=i.d,!f||d(()=>f.k.every(u=>a(u)===f.c(u)))){i.s=0;break}i.v=f.f;case 2:i.s=4;try{r(o,l,0,d(h=i.v,l,p=[])),p.length&&(i.d={c:a,f:h,k:p});break}catch(u){i.s=3,i.v=u,i.d=null}case 3:throw i.v;case 4:throw new Error(`Factory ${String(i.v)} didn't resolve ${String(l)}`)}}:l=>E.this(l),{def(l,i){return r(o,l,2,i),a},set(l,i){return r(o,l,1,i),a},fork(l){let i=s(o);return l!=null?i(l):i}});return n?a.use=a:a;function d(l,i,f){let h=x,p=T;try{return x=a,T=f,l(i)}finally{x=h,T=p}}}function r(n,o,a,d){if(n.has(o)){let l=n.get(o);if(!l.s)throw new Error(`Already read: ${String(o)}`);l.s=a,l.v=d,l.d=null}else n.set(o,{s:a,v:d})}function t(n){if(typeof n[R]=="function")return n[R](n);if(e(n))return typeof n.prototype[I]=="function"?n.prototype[I]():new n;throw new ReferenceError(`No config for ${String(n)}`)}function e(n){return typeof n=="function"&&n.prototype!==void 0&&(Object.getPrototypeOf(n.prototype)!==Object.prototype||Object.getOwnPropertyNames(n.prototype).length>1||n.toString().startsWith("class"))}}();var V,v=(V=window.queueMicrotask)!=null?V:(s=>r=>s.then(r))(Promise.resolve());E.def(b.Plugin,()=>{throw new Error("Plugin not created yet")});var L=class extends b.Component{constructor(){super(...arguments);this.use=E.service(this)}};E.service=function(s){return E(P).addChild(s),E.this};E.plugin=function(s){let r=E.fork().set(b.Plugin,s).set(s.constructor,s);return s.addChild(r.use(P)),r};var P=class extends b.Component{constructor(){super(...arguments);this.children=new Set([this])}onload(){this.loaded=!0}onunload(){this.loaded=!1,this.children.clear()}addChild(t){return this.children.has(t)||(this.children.add(t),this.loaded?v(()=>super.addChild(t)):super.addChild(t)),t}};function A(s,r){let t=new b.Component;t.onload=()=>{s.removeChild(t),r()},s.addChild(t)}var D=require("obsidian");var F=require("obsidian");var M=2,Wt=Symbol.for(`v${M}.layout-storage-events.ophidian.peak-dev.org`);var Ot=`ophidian-layout-storage:v${M}:item-load`,Rt=`ophidian-layout-storage:v${M}:item-save`;var $=require("obsidian");var N=class extends $.Component{constructor(t,e){super();this.use=t;this.container=e;this.win=this.container.win}[E.factory](){return new B(this.constructor)}static onload(t){}static onunload(t){}},B=class extends L{constructor(t){super();this.factory=t;this.instances=new Map;this.watching=!1;this.layoutReadyCallbacks=[]}onload(){var t,e;this.registerEvent(app.workspace.on("layout-change",()=>{app.workspace.layoutReady&&this.layoutReadyCallbacks.length&&(this.layoutReadyCallbacks.forEach(v),this.layoutReadyCallbacks=[])})),(e=(t=this.factory).onload)==null||e.call(t,this)}onLeafChange(t,e){return this.onLayoutReady(()=>t.call(e,app.workspace.activeLeaf)),app.workspace.on("active-leaf-change",n=>{app.workspace.layoutReady&&t.call(e,n)})}onLayoutReady(t){app.workspace.layoutReady?v(t):this.layoutReadyCallbacks.push(t)}onunload(){var t,e;(e=(t=this.factory).onunload)==null||e.call(t,this)}watch(){if(!this._loaded)A(this,()=>this.watch());else if(!this.watching){let{workspace:t}=app,e=this;this.watching=!0,this.registerEvent(t.on("window-open",n=>{this.onLayoutReady(()=>this.forContainer(n))})),this.register(m(t,{clearLayout(n){return async function(){try{return await n.call(this)}finally{e.onLayoutReady(()=>e.forAll())}}}})),this.onLayoutReady(()=>this.forAll())}return this}forWindow(t=(n=>(n=window.activeWindow)!=null?n:window)(),e=!0){let o=rt(t);if(o)return this.forContainer(o,e)}forContainer(t,e=!0){t=t.getContainer();let n=this.instances.get(t);return!n&&e&&(n=new this.factory(this.use,t),n&&(this.instances.set(t,n),this.addChild(n),t.component.addChild(n),n.register(()=>{z(this,n),z(t.component,n),this.instances.delete(t)}))),n}forDom(t,e=!0){return this.forWindow(it(t),e)}forLeaf(t=app.workspace.activeLeaf,e=!0){if(app.workspace.isLeafAttached(t))return this.forContainer(t.getContainer(),e)}forView(t,e=!0){return this.forLeaf(t.leaf,e)}forAll(t=!0){return st().map(e=>this.forContainer(e,t)).filter(e=>e)}};function z(s,r){s._loaded&&s.removeChild(r)}function st(){return[app.workspace.rootSplit].concat(app.workspace.floatingSplit.children)}function it(s){return s.win||(s.ownerDocument||s).defaultView||window}function rt(s){if(s===window)return app.workspace.rootSplit;let{floatingSplit:r}=app.workspace;if(r){for(let t of r.children)if(s===t.win)return t}}function q(s,r,t,e,n){return s.on(r,t,e,n),()=>s.off(r,t,e,n)}var G=require("obsidian");function _(){let s,r,t=new Promise((e,n)=>{s=e,r=n});return{resolve:s,reject:r,promise:t}}function K(s,r,t,e){let{resolve:n,promise:o}=_(),a=new class extends G.FuzzySuggestModal{getItemText(l){var i;return(i=r==null?void 0:r(l))!=null?i:""+l}getItems(){return s}onChooseItem(l,i){n({item:l,event:i})}onClose(){super.onClose(),v(()=>n({item:null,event:null}))}}(app);return t&&a.setPlaceholder(t),e==null||e(a),a.open(),o}function at(s){return y.Keymap.compileModifiers(s.modifiers)+","+s.key.toLowerCase()}function lt(s){return s==="plugins"||s==="community-plugins"}function J(){var s;return U()&&lt((s=app.setting.activeTab)==null?void 0:s.id)}function U(){return app.setting.containerEl.parentElement!==null}function ct(s){return s instanceof y.Modal&&s.hasOwnProperty("autoload")&&typeof s.showPlugin=="function"&&typeof s.updateSearch=="function"&&typeof s.searchEl=="object"}var W=class extends y.Plugin{constructor(){super(...arguments);this.lastSearch={};this.hotkeyButtons={};this.configButtons={};this.globalsAdded=!1;this.searchInput=null;this.commandsByPlugin={};this.assignedKeyCount={}}onload(){let t=this.app.workspace,e=this,n=t;this.registerEvent(n.on("plugin-settings:before-display",(d,l)=>{this.hotkeyButtons={},this.configButtons={},this.globalsAdded=!1,this.searchInput=null;let i=m(y.Setting.prototype,{addSearch(f){return function(h){return i(),f.call(this,p=>{e.searchInput=p,h==null||h(p)})}}});v(i)})),this.registerEvent(n.on("plugin-settings:after-display",()=>this.refreshButtons(!0))),this.registerEvent(n.on("plugin-settings:plugin-control",(d,l,i,f)=>{this.globalsAdded||this.addGlobals(f,d.settingEl),this.createExtraButtons(d,l,i)}));let o=(0,y.debounce)(this.refreshButtons.bind(this),50,!0);function a(d){return function(...l){return o(),d.apply(this,l)}}this.register(m(app.commands,{addCommand:a,removeCommand:a})),this.register(m(app.setting,{addSettingTab:a,removeSettingTab:a})),t.onLayoutReady(this.whenReady.bind(this)),this.registerObsidianProtocolHandler("goto-plugin",({id:d,show:l})=>{t.onLayoutReady(()=>{this.gotoPlugin(d,l)})})}whenReady(){var h,p;let t=this.app,e=this,n=(p=(h=t.internalPlugins.plugins["command-palette"])==null?void 0:h.instance)==null?void 0:p.modal;if(n){this.register(m(n,{onChooseItem(c){return function(k,C){return y.Keymap.isModEvent(C)?(v(()=>e.showHotkeysFor(k.name)),!1):c.call(this,k,C)}}}));let u=n.modalEl.find(".prompt-instructions .prompt-instruction");u&&createDiv("prompt-instruction",c=>{c.createSpan({cls:"prompt-instruction-command",text:y.Keymap.compileModifiers(["Mod"])+"+\u21B5"}),c.appendText(" "),c.createSpan({text:"to configure hotkey(s)"}),this.register(()=>c.detach())}).insertAfter(u)}this.register(m(t.setting,{onOpen(u){return function(...c){u.apply(this,c),!y.Platform.isMobile&&e.lastTabId&&this.openTabById(e.lastTabId)}},onClose(u){return function(...c){var g;return e.lastTabId=(g=this.activeTab)==null?void 0:g.id,u.apply(this,c)}}}));let o=this.getSettingsTab("plugins"),a=this.getSettingsTab("community-plugins");o&&this.register(m(o,{display:this.addPluginSettingEvents.bind(this,o.id)})),a&&this.register(m(a,{display:this.addPluginSettingEvents.bind(this,a.id)}));let d=()=>this.enhanceViewer();a&&this.register(q(a.containerEl,"click",".mod-cta, .installed-plugins-container .setting-item-info",d,!0)),this.register(m(t.workspace.protocolHandlers,{get(u){return function(g){return g==="show-plugin"&&d(),u.call(this,g)}}}));function l(){J()&&t.setting.openTabById(t.setting.activeTab.id)}l(),this.register(()=>v(l));let i=this.getSettingsTab("hotkeys");i&&this.register(m(i,{display(u){return function(){u.call(this),this.searchInputEl.focus()}},updateHotkeyVisibility(u){return function(){let c=this.searchInputEl.value,g=t.commands.commands;try{if(c.endsWith(":")&&!c.contains(" ")){let k=g,C=Object.fromEntries(Object.entries(t.commands.commands).filter(([w,S])=>(w+":").startsWith(c)));this.searchInputEl.value="",t.commands.commands=new Proxy(g,{ownKeys(){try{return Object.keys(k)}finally{k=C}}})}return u.call(this)}finally{this.searchInputEl.value=c,t.commands.commands=g}}}})),this.addCommand({id:"open-plugins",name:"Open the Community Plugins settings",callback:()=>this.showSettings("community-plugins")||!0}),this.addCommand({id:"browse-plugins",name:"Browse or search the Community Plugins catalog",callback:()=>this.gotoPlugin()});let f=new Intl.Collator(void 0,{usage:"sort",sensitivity:"base",numeric:!0}).compare;this.addCommand({id:"open-settings",name:"Open settings for plugin...",callback:async()=>{let{item:u}=await K(t.setting.pluginTabs.concat(t.setting.settingTabs).sort((c,g)=>f(c.name,g.name)),c=>c.name,"Select a plugin to open its settings...");u&&(t.setting.open(),t.setting.openTabById(u.id))}}),this.addCommand({id:"open-hotkeys",name:"Open hotkeys for plugin...",callback:async()=>{var k,C;let u=this.refreshCommands(),c=Object.values(t.plugins.plugins).map(w=>w.manifest).concat(Object.entries(t.internalPlugins.plugins).map(([w,{instance:{name:S},_loaded:Q}])=>({id:w,name:S,enabled:Q})).filter(w=>w.enabled)).concat([{id:"app",name:"App"},{id:"editor",name:((k=this.getSettingsTab("editor"))==null?void 0:k.name)||"Editor"},{id:"workspace",name:((C=this.getSettingsTab("file"))==null?void 0:C.name)||"Files & Links"}]).filter(w=>{var S;return(S=u[w.id])==null?void 0:S.length}),{item:g}=await K(c.sort((w,S)=>f(w.name,S.name)),w=>w.name,"Select a plugin to open its hotkeys...");g&&this.showHotkeysFor(g.id+":")}})}createExtraButtons(t,e,n){t.addExtraButton(o=>{o.setIcon("gear"),o.onClick(()=>this.showConfigFor(e.id.replace(/^workspace$/,"file"))),o.setTooltip("Options"),o.extraSettingsEl.toggle(n),this.configButtons[e.id]=o}),t.addExtraButton(o=>{o.setIcon("any-key"),o.onClick(()=>this.showHotkeysFor(e.id+":")),o.extraSettingsEl.toggle(n),this.hotkeyButtons[e.id]=o})}addGlobals(t,e){var l,i,f;this.globalsAdded=!0;let n=e.parentElement,o;if(t!=="plugins"||this.searchInput)(l=o=this.searchInput)==null||l.onChange(d);else{let h=new y.Setting(n).addSearch(p=>{o=p,p.setPlaceholder("Filter plugins...").onChange(d)});o.containerEl.style.margin="0",n.createDiv("hotkey-search-container").append(o.containerEl),h.settingEl.detach()}t==="community-plugins"&&o.inputEl.addEventListener("keyup",h=>{if(h.keyCode===13&&!y.Keymap.getModifiers(h))return this.gotoPlugin(),!1});let a=this;function d(h){let p=(a.lastSearch[t]=h).toLowerCase();function u(c){if(!c)return!1;let g=c.textContent=c.textContent,k=g.toLowerCase().indexOf(p);return~k?(c.textContent=g.substr(0,k),c.createSpan("suggestion-highlight").textContent=g.substr(k,p.length),c.insertAdjacentText("beforeend",g.substr(k+p.length)),!0):!1}n.findAll(".setting-item").forEach(c=>{var w;let g=u(c.find(".setting-item-name")),k=u((w=c.find(".setting-item-description > div:last-child"))!=null?w:c.find(".setting-item-description")),C=u(c.find(".setting-item-description > div:nth-child(2)"));c.toggle(g||k||C)})}if(v(()=>{!o||(o&&typeof a.lastSearch[t]=="string"&&(o.setValue(a.lastSearch[t]),o.onChanged()),y.Platform.isMobile||o.inputEl.select())}),n.append(e),t==="plugins"){let h=((i=this.getSettingsTab("editor"))==null?void 0:i.name)||"Editor",p=((f=this.getSettingsTab("file"))==null?void 0:f.name)||"Files & Links";this.createExtraButtons(new y.Setting(e.parentElement).setName("App").setDesc("Miscellaneous application commands (always enabled)"),{id:"app",name:"App"},!0),this.createExtraButtons(new y.Setting(e.parentElement).setName(h).setDesc("Core editing commands (always enabled)"),{id:"editor",name:h},!0),this.createExtraButtons(new y.Setting(e.parentElement).setName(p).setDesc("Core file and pane management commands (always enabled)"),{id:"workspace",name:p},!0),e.parentElement.append(e)}}enhanceViewer(){let t=this;v(m(y.Modal.prototype,{open(e){return function(...n){return ct(this)&&(v(()=>{if(t.lastSearch["community-plugins"]){let o=this.searchResultEl.cloneNode();this.searchContainerEl.replaceChild(o,this.searchResultEl),this.searchResultEl=o,this.searchEl.value=t.lastSearch["community-plugins"],this.searchEl.dispatchEvent(new Event("input"))}this.searchEl.select()}),t.currentViewer=this,m(this,{updateSearch:j,close(o){return function(...a){return t.currentViewer=null,o.apply(this,a)}},showPlugin(o){return async function(a){let d=await o.call(this,a);if(t.app.plugins.plugins[a.id]){let l=this.pluginContentEl.find("button").parentElement,i=[i18next.t("setting.options"),i18next.t("setting.hotkeys.name")];for(let p of l.findAll("button"))i.indexOf(p.textContent)!==-1&&p.detach();let f=l.createEl("button",{prepend:!0,text:"Hotkeys"}),h=l.createEl("button",{prepend:!0,text:"Options"});t.hotkeyButtons[a.id]={setTooltip(p){return f.title=p,this},extraSettingsEl:f},t.configButtons[a.id]={setTooltip(){return this},extraSettingsEl:h},t.refreshButtons(!0),f.addEventListener("click",()=>{this.close(),t.showHotkeysFor(a.id+":")}),h.addEventListener("click",()=>{this.close(),t.showConfigFor(a.id)})}return d}}})),e.apply(this,n)}}}))}getSettingsTab(t){return app.setting.settingTabs.filter(e=>e.id===t).shift()}addPluginSettingEvents(t,e){let n=this.app,o=!1;function a(d,...l){o=!0;try{n.workspace.trigger(d,...l)}catch(i){console.error(i)}o=!1}return function(...l){if(o)return;a("plugin-settings:before-display",this,t);let i;t==="plugins"?i=Object.entries(n.internalPlugins.plugins).map(([p,{instance:{name:u,hiddenFromList:c},_loaded:g}])=>!c&&{id:p,name:u,enabled:g}).filter(p=>p):i=Object.values(n.plugins.manifests),i.sort((p,u)=>p.name.localeCompare(u.name));let f=0,h=m(y.Setting.prototype,{addToggle(p){return function(...u){if(t==="plugins"&&!o&&(i[f]||{}).name===this.nameEl.textContent){let c=i[f++];a("plugin-settings:plugin-control",this,c,c.enabled,t)}return p.apply(this,u)}},addExtraButton(p){return function(u){if(t!=="plugins"&&this.descEl.childElementCount&&!o&&(i[f]||{}).name===this.nameEl.textContent){let c=i[f++],g=!!n.plugins.plugins[c.id];a("plugin-settings:plugin-control",this,c,g,t)}return p.call(this,function(c){u(c),!o&&c.extraSettingsEl.find("svg.gear, svg.any-key")&&c.extraSettingsEl.detach()})}}});try{return e.apply(this,l)}finally{h(),a("plugin-settings:after-display",this)}}}gotoPlugin(t,e="info"){if(t&&e==="hotkeys")return this.showHotkeysFor(t+":");if(t&&e==="config"){this.showConfigFor(t)||this.app.setting.close();return}this.showSettings("community-plugins");let n=m(y.Modal.prototype,{open(o){return function(...a){return n(),t&&(this.autoload=t),o.apply(this,a)}}});this.app.setting.activeTab.containerEl.find(".mod-cta").click()}showSettings(t){var e,n;if((e=this.currentViewer)==null||e.close(),U()||app.setting.open(),t)return app.setting.openTabById(t),((n=app.setting.activeTab)==null?void 0:n.id)===t?app.setting.activeTab:!1}showHotkeysFor(t){let e=this.showSettings("hotkeys");e&&e.searchInputEl&&e.updateHotkeyVisibility&&(e.searchInputEl.value=t,e.updateHotkeyVisibility())}showConfigFor(t){return this.showSettings(t)?!0:(new y.Notice(`No settings tab for "${t}": it may not be installed or might not have settings.`),!1)}pluginEnabled(t){var e;return((e=app.internalPlugins.plugins[t])==null?void 0:e._loaded)||app.plugins.plugins[t]}refreshCommands(){let t=app.hotkeyManager;return this.assignedKeyCount={},this.commandsByPlugin=Object.values(app.commands.commands).reduce((e,n)=>{let o=n.id.split(":",2).shift(),a=(t.getHotkeys(n.id)||t.getDefaultHotkeys(n.id)||[]).map(at);return a.forEach(d=>this.assignedKeyCount[d]=1+(this.assignedKeyCount[d]||0)),(e[o]||(e[o]=[])).push({hotkeys:a,cmd:n}),e},{})}refreshButtons(t=!1){if(!J()&&!t)return;this.refreshCommands();let e=Object.values(app.setting.pluginTabs).reduce((n,o)=>(n[o.id]=o,n),{});e.workspace=e.editor=!0;for(let n of Object.keys(this.configButtons||{})){let o=this.configButtons[n];if(!e[n]){o.extraSettingsEl.hide();continue}o.extraSettingsEl.show()}for(let n of Object.keys(this.hotkeyButtons||{})){let o=this.hotkeyButtons[n];if(!this.commandsByPlugin[n]){o.extraSettingsEl.hide();continue}let a=this.commandsByPlugin[n].filter(l=>l.hotkeys.length),d=a.filter(l=>l.hotkeys.filter(i=>this.assignedKeyCount[i]>1).length).length;o.setTooltip(`Configure hotkeys
(${a.length}/${this.commandsByPlugin[n].length} assigned${d?"; "+d+" conflicting":""})`),o.extraSettingsEl.toggleClass("mod-error",!!d),o.extraSettingsEl.show()}}};
